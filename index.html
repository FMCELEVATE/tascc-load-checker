<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FMC Haulage - Load Checker</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="https://fmcelevate.github.io/tascc-load-checker/fmc-logo.png">
  <meta name="theme-color" content="#0094e9">
  <style>
    :root {
      --primary-color: #0094e9;
      --text-color: #000;
      --background-color: #fff;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --primary-color: #0094e9;
        --text-color: #fff;
        --background-color: #121212;
      }
    }

    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 20px;
      background-color: var(--background-color);
      color: var(--text-color);
    }
    input, button {
      padding: 15px;
      font-size: 18px;
      margin: 10px 5px;
      border: 1px solid var(--primary-color);
      border-radius: 5px;
      width: 80%;
      max-width: 300px;
    }
    button {
      background-color: var(--primary-color);
      color: #fff;
      cursor: pointer;
    }
    button:hover {
      opacity: 0.9;
    }
    .results {
      margin-top: 20px;
      font-size: 18px;
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.5s ease, transform 0.5s ease;
    }
    .results.show {
      opacity: 1;
      transform: translateY(0);
    }
    #logo {
      width: 150px;
      margin-bottom: 20px;
    }
    ul { list-style: none; padding: 0; }
    li { margin: 10px 0; }
    details summary {
      cursor: pointer;
      font-weight: bold;
    }
    details summary::-webkit-details-marker {
      display: none;
    }
    #toast {
      visibility: hidden;
      min-width: 200px;
      margin-left: -100px;
      background-color: #333;
      color: #fff;
      text-align: center;
      border-radius: 5px;
      padding: 12px;
      position: fixed;
      z-index: 1;
      left: 50%;
      bottom: 30px;
      font-size: 16px;
      opacity: 0;
      transition: opacity 0.5s, visibility 0.5s;
    }
    #toast.show {
      visibility: visible;
      opacity: 1;
    }
  </style>
</head>
<body>
  <img src="https://fmcelevate.github.io/tascc-load-checker/fmc-logo.png" alt="FMC Logo" id="logo">
  <h1>FMC Haulage - Load Checker</h1>
  <p>Enter your Trailer Number below to view last 3 loads:</p>

  <input type="text" id="trailerInput" placeholder="Enter Trailer Number" autofocus>
  <div>
    <button onclick="searchLoads()">Search</button>
    <button onclick="clearSearch()">Clear</button>
    <button onclick="window.open('https://docs.google.com/forms/d/e/1FAIpQLScmL0n-CUMiF7btBvdySBN7pygA2jy9Cm1onRzfEqcd_kY_Gg/viewform', '_blank')">Submit Load</button>
  </div>

  <div class="results" id="results"></div>

  <!-- Custom Load Form -->
  <div id="loadForm" style="display: none; margin-top: 20px;">
    <h2>Submit New Load</h2>
    <form id="submitLoadForm">
      <input type="text" id="trailerNumber" name="Trailer Number" placeholder="Trailer Number" readonly>
      <input type="text" name="Commodity" placeholder="Commodity" required>
      <input type="text" name="Collection Point" placeholder="Collection Point" required>
      <input type="text" name="Delivery Point" placeholder="Delivery Point" required>
      <input type="text" name="Order Number" placeholder="Order Number (optional)">
      <input type="number" name="Weight" placeholder="Weight (Tons)" step="0.01" required>
      <select name="Cleaning Method" required>
        <option value="">Select Cleaning Method</option>
        <option value="Swept">Swept</option>
        <option value="Washed">Washed</option>
      </select>
      <input type="text" name="Driver Name" placeholder="Driver Name" required>
      <button type="submit">Submit Load</button>
    </form>
  </div>

  <div id="toast"></div>

  <script>
    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.innerText = message;
      toast.className = 'show';
      setTimeout(() => { toast.className = toast.className.replace('show', ''); }, 3000);
    }

    function clearSearch() {
      document.getElementById('trailerInput').value = '';
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = '';
      resultsDiv.classList.remove('show');
      document.getElementById('trailerInput').focus();
      showToast('Form cleared');
    }

    async function searchLoads() {
      const rawInput = document.getElementById('trailerInput').value.trim().toUpperCase();
      const trailer = rawInput.replace(/\s+/g, '').replace(/^FMC/, '');
      const displayTrailer = 'FMC ' + trailer;
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = '<div>Loading...</div>';
      resultsDiv.classList.remove('show');

      if (!trailer) {
        resultsDiv.innerHTML = 'Please enter a trailer number.';
        showToast('Please enter a trailer number');
        return;
      }

      const sheetId = '1UF0ElphUQaBrxpmnP4Urrudf26VqVp4HF0UyjJjCNhE';
      const apiKey = 'AIzaSyCEUSt7v7iNP3fbYUzCuwN2RVp0cQTOQ5o';
      const range = "'Form Responses 1'!A:K";

      try {
        const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${range}?key=${apiKey}`);
        const data = await response.json();
        let rows = data.values;

        if (!rows || rows.length <= 1) {
          resultsDiv.innerHTML = 'No data found. Please check with the office.';
          showToast('No data found');
          return;
        }

        rows = rows.slice(1);

        const matchingRows = rows.filter(row => {
          if (!row[1]) return false;
          const trailerFromSheet = row[1].toUpperCase().replace(/\s+/g, '').replace(/^FMC/, '');
          return trailerFromSheet === trailer;
        });

        if (matchingRows.length === 0) {
          resultsDiv.innerHTML = `No recent load records found for trailer FMC ${trailer}.`;
          showToast('No records found');
          return;
        }

        matchingRows.sort((a, b) => new Date(b[0]) - new Date(a[0]));

        let output = `<strong>Last 3 loads for FMC ${trailer}:</strong><br><ul>`;
        matchingRows.slice(0, 3).forEach(row => {
          const load = row[2] ? row[2] : 'Unknown Load';
          output += `<li><details><summary>${load}</summary></details></li>`;
        });
        output += '</ul>';

        resultsDiv.innerHTML = output;
        resultsDiv.classList.add('show');

        // Show Load Form with trailer number prefilled
        document.getElementById('loadForm').style.display = 'block';
        document.getElementById('trailerNumber').value = displayTrailer;

      } catch (error) {
        console.error('Error fetching data', error);
        resultsDiv.innerHTML = 'Error fetching data. Please try again later.';
        showToast('Error fetching data');
      }
    }

    document.getElementById('submitLoadForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const formData = new FormData(this);
      const params = new URLSearchParams();
      for (const pair of formData) {
        params.append(pair[0], pair[1]);
      }

      try {
        await fetch('YOUR_WEB_APP_URL', {
          method: 'POST',
          body: params
        });
        alert('Load submitted successfully!');
        document.getElementById('submitLoadForm').reset();
        document.getElementById('loadForm').style.display = 'none';
      } catch (error) {
        alert('Error submitting load. Please try again.');
        console.error(error);
      }
    });

    document.getElementById('trailerInput').addEventListener('keypress', function(event) {
      if (event.key === 'Enter') {
        searchLoads();
      }
    });
  </script>
</body>
</html>



